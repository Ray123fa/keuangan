#!/usr/bin/env php
<?php
declare(strict_types=1);

require_once __DIR__ . '/config.php';
require_once __DIR__ . '/database.php';
require_once __DIR__ . '/vendor/autoload.php';

use App\Console\MigrationRunner;
use App\Console\SeederRunner;

function printUsage(): void
{
    echo "Keuangan Artisan (custom)\n\n";
    echo "Usage:\n";
    echo "  php artisan make:migration <name>\n";
    echo "  php artisan make:seeder <name>\n";
    echo "  php artisan migrate\n";
    echo "  php artisan migrate --seed\n";
    echo "  php artisan migrate:fresh\n";
    echo "  php artisan migrate:fresh --force\n";
    echo "  php artisan migrate:fresh --seed --force\n";
    echo "  php artisan migrate:rollback\n";
    echo "  php artisan migrate:status\n";
    echo "  php artisan db:seed\n";
    echo "  php artisan db:seed --class=CategorySeeder\n";
}

function pdoOptions(): array
{
    return [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        \PDO::ATTR_DEFAULT_FETCH_MODE => \PDO::FETCH_ASSOC,
        \PDO::ATTR_EMULATE_PREPARES => false,
    ];
}

function connectDatabase(): \PDO
{
    $dsn = sprintf(
        'mysql:host=%s;port=%d;dbname=%s;charset=%s',
        DB_HOST,
        (int) DB_PORT,
        DB_NAME,
        DB_CHARSET
    );

    return new \PDO($dsn, DB_USER, DB_PASS, pdoOptions());
}

function connectServer(): \PDO
{
    $dsn = sprintf(
        'mysql:host=%s;port=%d;charset=%s',
        DB_HOST,
        (int) DB_PORT,
        DB_CHARSET
    );

    return new \PDO($dsn, DB_USER, DB_PASS, pdoOptions());
}

function shouldAutoCreateDatabase(string $command): bool
{
    return in_array($command, ['migrate', 'migrate:fresh', 'migrate:rollback', 'migrate:status', 'db:seed'], true);
}

function isUnknownDatabaseError(\PDOException $exception): bool
{
    if ((int) $exception->getCode() === 1049) {
        return true;
    }

    return stripos($exception->getMessage(), 'Unknown database') !== false;
}

function createDatabaseFromEnv(): void
{
    $serverPdo = connectServer();
    $databaseName = str_replace('`', '``', DB_NAME);
    $serverPdo->exec(
        'CREATE DATABASE IF NOT EXISTS `' . $databaseName . '` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci'
    );
}

function resolvePdo(string $command): \PDO
{
    try {
        return connectDatabase();
    } catch (\PDOException $exception) {
        if (!shouldAutoCreateDatabase($command) || !isUnknownDatabaseError($exception)) {
            throw $exception;
        }

        fwrite(STDOUT, 'Database ' . DB_NAME . " tidak ditemukan. Membuat database...\n");
        createDatabaseFromEnv();
        fwrite(STDOUT, "Database berhasil dibuat.\n");

        return connectDatabase();
    }
}

function hasOption(array $args, string $option): bool
{
    return in_array($option, $args, true);
}

function getOptionValue(array $args, string $option): ?string
{
    $prefix = $option . '=';

    foreach ($args as $index => $arg) {
        if (str_starts_with($arg, $prefix)) {
            $value = substr($arg, strlen($prefix));
            return $value === '' ? null : $value;
        }

        if ($arg === $option) {
            $next = $args[$index + 1] ?? null;
            if ($next === null || str_starts_with($next, '--')) {
                return null;
            }

            return $next;
        }
    }

    return null;
}

function confirmProductionFresh(array $args): void
{
    if (APP_ENV !== 'production') {
        return;
    }

    if (hasOption($args, '--force')) {
        return;
    }

    fwrite(STDOUT, "\nAPPLICATION IN PRODUCTION.\n");
    fwrite(STDOUT, "This will DROP ALL TABLES in the current database.\n");
    fwrite(STDOUT, "Do you really wish to run this command? (yes/no) ");

    $answer = fgets(STDIN);
    if ($answer === false) {
        throw new RuntimeException('Gagal membaca input konfirmasi. Gunakan --force jika non-interactive.');
    }

    if (strtolower(trim($answer)) !== 'yes') {
        throw new RuntimeException('Command dibatalkan.');
    }
}

$command = $argv[1] ?? 'help';
$args = array_slice($argv, 2);

if (in_array($command, ['help', '-h', '--help'], true)) {
    printUsage();
    exit(0);
}

try {
    switch ($command) {
        case 'make:migration':
            $migrationName = $args[0] ?? null;
            if ($migrationName === null || trim($migrationName) === '') {
                throw new InvalidArgumentException('Nama migration wajib diisi. Contoh: php artisan make:migration create_users_table');
            }

            $pdo = resolvePdo($command);
            $runner = new MigrationRunner($pdo, __DIR__ . '/database/migrations');
            $runner->makeMigration($migrationName);
            break;

        case 'make:seeder':
            $seederName = $args[0] ?? null;
            if ($seederName === null || trim($seederName) === '') {
                throw new InvalidArgumentException('Nama seeder wajib diisi. Contoh: php artisan make:seeder CategorySeeder');
            }

            $pdo = resolvePdo($command);
            $seederRunner = new SeederRunner($pdo, __DIR__ . '/database/seeders');
            $seederRunner->makeSeeder($seederName);
            break;

        case 'migrate':
            $pdo = resolvePdo($command);
            $runner = new MigrationRunner($pdo, __DIR__ . '/database/migrations');
            $runner->migrate();
            if (hasOption($args, '--seed')) {
                $seederClass = getOptionValue($args, '--class');
                $seederRunner = new SeederRunner($pdo, __DIR__ . '/database/seeders');
                $seederRunner->seed($seederClass);
            }
            break;

        case 'migrate:fresh':
            confirmProductionFresh($args);
            $pdo = resolvePdo($command);
            $runner = new MigrationRunner($pdo, __DIR__ . '/database/migrations');
            $runner->fresh();
            if (hasOption($args, '--seed')) {
                $seederClass = getOptionValue($args, '--class');
                $seederRunner = new SeederRunner($pdo, __DIR__ . '/database/seeders');
                $seederRunner->seed($seederClass);
            }
            break;

        case 'migrate:rollback':
            $pdo = resolvePdo($command);
            $runner = new MigrationRunner($pdo, __DIR__ . '/database/migrations');
            $runner->rollback();
            break;

        case 'migrate:status':
            $pdo = resolvePdo($command);
            $runner = new MigrationRunner($pdo, __DIR__ . '/database/migrations');
            $runner->status();
            break;

        case 'db:seed':
            $pdo = resolvePdo($command);
            $seederRunner = new SeederRunner($pdo, __DIR__ . '/database/seeders');
            $seederClass = getOptionValue($args, '--class');
            $seederRunner->seed($seederClass);
            break;

        default:
            throw new InvalidArgumentException("Command tidak dikenal: {$command}");
    }
} catch (Throwable $exception) {
    fwrite(STDERR, '[ERROR] ' . $exception->getMessage() . PHP_EOL);
    exit(1);
}

exit(0);
